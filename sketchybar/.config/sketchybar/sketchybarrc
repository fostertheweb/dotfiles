#!/bin/bash

PLUGIN_DIR="$CONFIG_DIR/plugins"

source "$CONFIG_DIR/colors.sh"
source "$PLUGIN_DIR/icon_map.sh"

bar=(
  position=top
  height=36
  blur_radius=10
)

default=(
  padding_left=0
  padding_right=0
  icon.font="Hack Nerd Font:Regular:14.0"
  label.font="SF Pro:Semibold:12.0"
  icon.color=$WHITE
  label.color=$WHITE
  icon.padding_left=10
  icon.padding_right=10
  label.padding_left=0
  label.padding_right=10
  background.padding_left=0
  background.padding_right=0
)
sketchybar --bar "${bar[@]}" --default "${default[@]}"

sketchybar --add event aerospace_workspace_change

for sid in $(echo -e "1\n2\n3\n8\n9\n0"); do
  sketchybar --add item space.$sid left \
    --subscribe space.$sid aerospace_workspace_change \
    --set space.$sid \
    background.color="$GRAY_TRANSPARENT" \
    background.corner_radius=5 \
    background.height=25 \
    background.padding_left=6 \
    background.padding_right=6 \
    y_offset=1 \
    label.drawing=off \
    icon="$sid" \
    icon.drawing=on \
    icon.font="SF Pro:Bold:12.0" \
    click_script="aerospace workspace $sid" \
    script="$CONFIG_DIR/plugins/aerospace.sh $sid"

  apps=$(aerospace list-windows --workspace $sid 2>/dev/null | awk -F' \\| ' '{print $2}' | sort -u)

  if [ -n "$apps" ]; then
    for app in $apps; do
      sketchybar --add item app.$app left \
        --subscribe app.$app front_app_switched aerospace_workspace_change \
        --set app.$app \
        script="$PLUGIN_DIR/apps.sh $app $sid" \
        y_offset=1
    done
  fi
done

sketchybar --add item clock right \
  --set clock update_freq=10 script="$PLUGIN_DIR/clock.sh" \
  --add item battery right \
  --set battery update_freq=120 icon.drawing=on icon.font="Hack Nerd Font:Regular:14.0" script="$PLUGIN_DIR/battery.sh" \
  --subscribe battery system_woke power_source_change \
  --add item calendar_event right \
  --set calendar_event \
  update_freq=60 \
  script="$PLUGIN_DIR/calendar_event.sh" \
  click_script="open -a Calendar" \
  icon.font="Hack Nerd Font:Regular:12.0" \
  label.color="$WHITE" \
  background.drawing=on \
  background.color="$GRAY_TRANSPARENT" \
  background.corner_radius=8 \
  background.height=25

sketchybar --update
